<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Förderwissensgraph | Interactive Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,600;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Instrument Sans"', 'sans-serif'],
                        serif: ['"Instrument Serif"', 'serif'],
                    },
                    colors: {
                        federal: {
                            900: '#001A33',
                            800: '#002244',
                            700: '#003366',
                            600: '#004488',
                            500: '#0055AA',
                        },
                        accent: {
                            gold: '#D4AF37',
                            slate: '#64748b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f9fafb;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3%3Cfilter id='noiseFilter'%3%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-blend-mode: overlay;
            opacity: 0.98;
        }

        .graph-container {
            cursor: grab;
        }
        .graph-container:active {
            cursor: grabbing;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.2s ease;
        }
        .node:hover {
            stroke: #000;
            stroke-width: 3px;
        }

        .link {
            stroke: #cbd5e1;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            fill: none;
            transition: all 0.2s ease;
        }

        .link.supersedes {
            stroke: #ef4444;
            stroke-dasharray: 4, 4;
        }

        .highlight-neighbor {
            stroke: #003366 !important;
            stroke-width: 3px !important;
        }

        .dimmed {
            opacity: 0.05;
            pointer-events: none; /* Make dimmed nodes unclickable */
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        #tooltip {
            pointer-events: none;
            z-index: 50;
        }

        .rule-card {
            border-left: 3px solid #003366;
        }
    </style>
</head>
<body class="h-screen overflow-hidden text-federal-900 selection:bg-federal-100">

    <div class="flex h-full">
        <!-- Main Content: Graph -->
        <main class="relative flex-1 bg-white/50 backdrop-blur-sm overflow-hidden">
            <!-- Header Overlay -->
            <div class="absolute top-6 left-8 z-10 pointer-events-none flex items-start gap-3">
                <div>
                    <h1 class="text-4xl font-serif italic mb-1">Förderwissensgraph</h1>
                    <p class="text-accent-slate text-sm font-sans tracking-wide uppercase">Interactive Document Intelligence Dashboard</p>
                </div>
                <button onclick="toggleInfo()" class="pointer-events-auto mt-2 p-1.5 bg-white/50 backdrop-blur rounded-full text-federal-600 hover:text-federal-900 hover:bg-white transition-all shadow-sm border border-federal-100" title="Über das Projekt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
            </div>

            <!-- Info Modal -->
            <div id="infoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-federal-900/40 backdrop-blur-sm p-4 transition-opacity duration-300">
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full relative overflow-hidden flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
                    
                    <!-- Decor element -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-accent-gold/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    
                    <div class="p-8 pb-4 border-b border-gray-100 flex justify-between items-start bg-gray-50/50">
                        <div>
                            <h2 class="text-2xl font-serif text-federal-900 mb-1">Über den Förderwissensgraph</h2>
                            <p class="text-sm text-gray-500 font-sans">Ein Projekt zur Digitalisierung des Fördermittel-Managements</p>
                        </div>
                        <button onclick="toggleInfo()" class="text-gray-400 hover:text-federal-900 transition-colors p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    
                    <div class="p-8 overflow-y-auto space-y-8 font-sans">
                        <!-- Section 1: The Graph -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-federal-100 flex items-center justify-center text-federal-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">High-Density Knowledge Graph</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Dieses Dashboard visualisiert nicht nur Dokumente, sondern deren <strong>Beziehungen</strong>. Es erkennt automatisch Referenzen (z.B. "siehe BNBest-P") und Versionierungen ("ersetzt durch"). 
                                    <br><span class="text-xs text-federal-500 mt-1 block">Technologie: NetworkX, D3.js, Docling PDF Parser</span>
                                </p>
                            </div>
                        </div>

                        <!-- Section 2: Hybrid Search -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-accent-gold/10 flex items-center justify-center text-accent-gold">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">Graph-Guided RAG</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Unsere Suche nutzt <strong>Hybrid Retrieval</strong> (Vektor + Keyword) und erweitert den Kontext über den Graphen ("Multi-Hop"). So kann die KI Fragen beantworten, die Wissen aus mehreren verknüpften Dokumenten erfordern.
                                    <br><span class="text-xs text-federal-500 mt-1 block">Technologie: ChromaDB, BM25, Cross-Encoder Reranking</span>
                                </p>
                            </div>
                        </div>

                        <!-- Section 3: API -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">Open API Schnittstelle</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Das gesamte System ist "API-First" gebaut. Entwickler können den Graphen, die Suche und die KI-Antworten direkt in eigene Anwendungen integrieren.
                                </p>
                                <a href="/api/docs" target="_blank" class="inline-flex items-center gap-1 mt-2 text-xs font-bold text-federal-600 hover:text-federal-800 border border-federal-200 px-3 py-1.5 rounded-lg hover:bg-federal-50 transition-colors">
                                    API Dokumentation öffnen
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-xs text-gray-400">
                        <span>Version 2.2.4</span>
                        <button onclick="toggleInfo()" class="px-4 py-2 bg-federal-900 text-white rounded-lg hover:bg-federal-800 font-bold transition-colors">Schließen</button>
                    </div>
                </div>
            </div>

            <!-- Controls Overlay -->
            <div class="absolute bottom-8 left-8 z-10 flex flex-col gap-4">
                <div class="bg-white/80 backdrop-blur-md p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3 pointer-events-auto">
                    <div class="text-xs font-semibold text-federal-700 uppercase tracking-tighter">Legend</div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full bg-federal-700"></span>
                        <span>Formularschrank</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                        <span>Gesetz</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-8 h-0 border-t-2 border-dashed border-red-500"></span>
                        <span>SUPERSEDES</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-8 h-0 border-t-2 border-accent-gold"></span>
                        <span>REFERENZ</span>
                    </div>
                </div>
                
                <div class="bg-white/80 backdrop-blur-md p-2 rounded-xl border border-gray-200 shadow-sm flex gap-2 pointer-events-auto">
                    <button onclick="zoomIn()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button onclick="zoomOut()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button onclick="resetZoom()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Reset">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><polyline points="3 3 3 8 8 8"></polyline></svg>
                    </button>
                    <button onclick="autoZoom()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Fit to View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Search Overlay -->
            <div class="absolute top-6 right-8 z-10 w-96 flex flex-col gap-4">
                <div class="relative group pointer-events-auto">
                    <input type="text" id="hybridSearchInput" placeholder="Hybrid Search (ChromaDB + Graph)..." 
                        class="w-full bg-white/90 backdrop-blur-md border border-gray-200 rounded-full px-5 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-federal-500 focus:border-transparent shadow-sm transition-all group-hover:shadow-md"
                        onkeydown="if(event.key === 'Enter') performHybridSearch(this.value)">
                    <button onclick="performHybridSearch(document.getElementById('hybridSearchInput').value)" class="absolute right-4 top-1/2 -translate-y-1/2 text-federal-600 hover:text-federal-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-white/80 backdrop-blur-md p-4 rounded-2xl border border-gray-200 shadow-sm pointer-events-auto flex flex-col gap-3 transition-all duration-300" id="filterContainer">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleFilters()">
                        <div class="flex items-center gap-2">
                            <div class="text-[10px] font-bold uppercase tracking-widest text-federal-700">Filter</div>
                            <svg id="filterArrow" class="w-3 h-3 text-federal-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <button onclick="event.stopPropagation(); clearFilters()" class="text-[9px] text-federal-500 hover:text-federal-800 font-bold uppercase tracking-tighter">Zurücksetzen</button>
                    </div>
                    <div id="filterContent" class="flex flex-col gap-3">
                        <select id="filterCategory" class="text-xs p-2 rounded-lg border border-gray-100 bg-white focus:outline-none focus:ring-1 focus:ring-federal-500 shadow-sm" onchange="handleCategoryChange()">
                            <option value="">Alle Kategorien</option>
                            <option value="document">Formularschrank</option>
                            <option value="law">Gesetze</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="filterMinistry" class="text-xs p-2 rounded-lg border border-gray-100 bg-white focus:outline-none focus:ring-1 focus:ring-federal-500 shadow-sm" onchange="applyFilters()">
                                <option value="">Alle Ressorts</option>
                            </select>
                            <select id="filterType" class="text-xs p-2 rounded-lg border border-gray-100 bg-white focus:outline-none focus:ring-1 focus:ring-federal-500 shadow-sm" onchange="applyFilters()">
                                <option value="">Alle Typen</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-bold text-gray-400 uppercase px-1">Zeitraum (Stand ab)</label>
                            <input type="month" id="filterDateStart" class="text-xs p-2 rounded-lg border border-gray-100 bg-white focus:outline-none focus:ring-1 focus:ring-federal-500 shadow-sm" onchange="applyFilters()">
                        </div>
                    </div>
                </div>

                <div id="searchResults" class="hidden bg-white/95 backdrop-blur-md rounded-2xl border border-gray-200 shadow-xl overflow-hidden pointer-events-auto max-h-[60vh] flex flex-col">
                    <div class="p-3 bg-federal-50 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-federal-700">Suchergebnisse</span>
                        <button onclick="document.getElementById('searchResults').classList.add('hidden')" class="text-gray-400 hover:text-federal-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div id="resultsList" class="overflow-y-auto sidebar-scroll p-4 space-y-4">
                        <!-- Results injected here -->
                    </div>
                </div>
            </div>

            <!-- SVG Container -->
            <svg id="graph" class="w-full h-full graph-container"></svg>
            
            <!-- Tooltip -->
            <div id="tooltip" class="absolute hidden bg-federal-900 text-white px-3 py-2 rounded-lg text-xs shadow-xl max-w-xs transition-opacity duration-200"></div>
        </main>

        <!-- Right Sidebar -->
        <aside id="sidebar" class="w-1/3 bg-white border-l border-gray-200 shadow-2xl flex flex-col z-20">
            <div class="p-8 border-b border-gray-100 bg-gray-50/50">
                <div class="flex justify-between items-start mb-4">
                    <span id="docCategory" class="text-[10px] font-bold tracking-widest uppercase text-federal-500 px-2 py-1 bg-federal-50 rounded">Kategorie</span>
                    <button onclick="closeSidebar()" class="text-gray-400 hover:text-federal-900 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <h2 id="docTitle" class="text-2xl font-serif leading-tight mb-2">Wählen Sie ein Dokument aus</h2>
                <div id="docKuerzel" class="text-xs text-federal-600 font-bold mb-4"></div>
                <div class="flex flex-wrap gap-2 mb-6">
                    <a id="docLink" href="#" target="_blank" class="text-xs flex items-center gap-1.5 text-federal-600 hover:text-federal-800 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        PDF Dokument öffnen
                    </a>
                </div>
                <div id="docStats" class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Regeln</div>
                        <div id="ruleCount" class="text-xl font-serif">0</div>
                    </div>
                    <div id="docIdContainer" class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">ID</div>
                        <div id="docId" class="text-xl font-serif">--</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto sidebar-scroll p-8">
                <h3 class="text-sm font-bold uppercase tracking-widest text-federal-800 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Extrahierte Regeln
                </h3>
                <div id="rulesList" class="space-y-6">
                    <!-- Rules will be injected here -->
                    <div class="text-center py-12 text-gray-400 italic font-serif">
                        Keine Regeln ausgewählt
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Data management
        let graphData = null;
        let knowledgeData = null;
        let documentRules = {}; // docId -> list of rules

        const svg = d3.select("#graph");
        const width = window.innerWidth * 0.66;
        const height = window.innerHeight;
        
        const g = svg.append("g");
        
        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => g.attr("transform", event.transform));

        svg.call(zoom);

        function zoomIn() { svg.transition().call(zoom.scaleBy, 1.3); }
        function zoomOut() { svg.transition().call(zoom.scaleBy, 0.7); }
        function resetZoom() { svg.transition().call(zoom.transform, d3.zoomIdentity); }
        
        function autoZoom() {
            // Get bounding box of all nodes
            const nodes = d3.selectAll(".node");
            if (nodes.empty()) return;
            
            // Calculate bounds
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            graphData.nodes.forEach(d => {
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });
            
            const dx = maxX - minX,
                  dy = maxY - minY,
                  x = (minX + maxX) / 2,
                  y = (minY + maxY) / 2,
                  scale = Math.max(0.1, Math.min(4, 0.9 / Math.max(dx / width, dy / height)));
            
            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(scale)
                .translate(-x, -y);
                
            svg.transition().duration(750).call(zoom.transform, transform);
        }

        function zoomToVisible() {
            // Get bounding box of visible (non-dimmed) nodes
            const visibleNodes = d3.selectAll(".node:not(.dimmed)");
            if (visibleNodes.empty()) return; // Keep current view if nothing visible
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            let count = 0;
            
            visibleNodes.each(d => {
                count++;
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });
            
            if (count === 0) return;

            const dx = maxX - minX || 100, // Fallback width if single point
                  dy = maxY - minY || 100,
                  x = (minX + maxX) / 2,
                  y = (minY + maxY) / 2,
                  scale = Math.max(0.1, Math.min(4, 0.9 / Math.max(dx / width, dy / height)));
            
            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(scale)
                .translate(-x, -y);
                
            svg.transition().duration(750).call(zoom.transform, transform);
        }

        // Simulation
        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(60));

        // Load Data
        async function loadData() {
            try {
                const [docsResponse, knowledgeResponse] = await Promise.all([
                    fetch('../data/d3_graph_documents.json'),
                    fetch('../data/knowledge_graph.json')
                ]);

                graphData = await docsResponse.json();
                knowledgeData = await knowledgeResponse.json();

                populateFilters();
                processRules();
                renderGraph();
                
                // Initial auto-zoom after simulation stabilizes a bit
                setTimeout(autoZoom, 800);
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Fehler beim Laden der Daten. Bitte stellen Sie sicher, dass Sie die Datei über einen Webserver öffnen.");
            }
        }

        function populateFilters() {
            const ministries = new Set();
            const types = new Set();

            graphData.nodes.forEach(n => {
                if (n.ministerium) {
                    const min = n.ministerium.trim();
                    if (min && min !== "unbekannt") ministries.add(min);
                }
                if (n.herausgeber) {
                    const iss = n.herausgeber.trim();
                    if (iss && iss !== "unbekannt") ministries.add(iss);
                }
                if (n.kuerzel) {
                    const type = n.kuerzel.trim();
                    if (type) types.add(type);
                }
            });

            const minSelect = document.getElementById('filterMinistry');
            minSelect.innerHTML = '<option value="">Alle Ressorts</option>';
            Array.from(ministries).sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                minSelect.appendChild(opt);
            });

            const typeSelect = document.getElementById('filterType');
            typeSelect.innerHTML = '<option value="">Alle Typen</option>';
            Array.from(types).sort().forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.innerText = t;
                typeSelect.appendChild(opt);
            });
        }

        function processRules() {
            knowledgeData.nodes.forEach(node => {
                if (node.type === 'chunk' && node.rules && node.rules.length > 0) {
                    const docId = node.id.split('_')[0];
                    if (!documentRules[docId]) documentRules[docId] = [];
                    
                    node.rules.forEach(rule => {
                        documentRules[docId].push({
                            ...rule,
                            context: node.context,
                            headings: node.headings
                        });
                    });
                }
            });
        }

        function renderGraph() {
            const nodes = graphData.nodes;
            const links = graphData.links;

            // Define arrowheads
            svg.append("defs").selectAll("marker")
                .data(["SUPERSEDES", "REFERENCES", "default"])
                .enter().append("marker")
                .attr("id", d => `arrow-${d}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("fill", d => {
                    if (d === "SUPERSEDES") return "#ef4444";
                    if (d === "REFERENCES") return "#D4AF37";
                    return "#cbd5e1";
                })
                .attr("d", "M0,-5L10,0L0,5");

            const linkElements = g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(links)
                .enter().append("path")
                .attr("class", d => `link ${d.relation?.toLowerCase() || ''}`)
                .attr("stroke", d => d.relation === "REFERENCES" ? "#D4AF37" : null)
                .attr("marker-end", d => {
                    if (d.relation === "SUPERSEDES") return "url(#arrow-SUPERSEDES)";
                    if (d.relation === "REFERENCES") return "url(#arrow-REFERENCES)";
                    return "url(#arrow-default)";
                });

            const nodeElements = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => (d.node_type === "law" || d.type === "law") ? 16 : 12)
                .attr("fill", d => (d.node_type === "law" || d.type === "law") ? "#f97316" : "#003366")
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", (e, d) => selectNode(d))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            const labels = g.append("g")
                .attr("class", "labels")
                .selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "text-[8px] font-sans fill-federal-500 pointer-events-none")
                .attr("dy", 24)
                .attr("text-anchor", "middle")
                .text(d => d.title.length > 25 ? d.title.substring(0, 22) + "..." : d.title);

            simulation.nodes(nodes).on("tick", () => {
                linkElements.attr("d", d => {
                    const dx = d.target.x - d.source.x,
                          dy = d.target.y - d.source.y,
                          dr = Math.sqrt(dx * dx + dy * dy);
                    // Use arcs for superseded links to distinguish
                    if (d.relation === "SUPERSEDES") {
                        return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                    }
                    return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
                });

                nodeElements
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            simulation.force("link").links(links);
        }

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tooltip
        const tooltip = d3.select("#tooltip");
        function showTooltip(event, d) {
            tooltip.style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px")
                .html(`
                    <div class="font-bold mb-1">${d.title}</div>
                    <div class="opacity-70">${d.category}</div>
                `);
            
            // Highlight neighbors
            const neighbors = new Set();
            graphData.links.forEach(l => {
                if (l.source.id === d.id) neighbors.add(l.target.id);
                if (l.target.id === d.id) neighbors.add(l.source.id);
            });

            d3.selectAll(".node").classed("dimmed", n => n.id !== d.id && !neighbors.has(n.id));
            d3.selectAll(".link").classed("dimmed", l => l.source.id !== d.id && l.target.id !== d.id);
        }

        function hideTooltip() {
            tooltip.style("display", "none");
            // Restore filter state (don't clear dimmed blindly)
            applyFilters(false); // false = don't zoom
        }

        // Sidebar & Interaction
        function selectNode(d) {
            document.getElementById('docTitle').innerText = d.title;
            document.getElementById('docKuerzel').innerText = d.kuerzel ? `[${d.kuerzel}]` : '';
            const categoryText = d.ministerium ? `${d.ministerium.toUpperCase()} | ${d.category}` : d.category;
            document.getElementById('docCategory').innerText = categoryText;
            document.getElementById('docId').innerText = d.id;
            document.getElementById('docLink').href = d.url;

            const rules = documentRules[d.id] || [];
            document.getElementById('ruleCount').innerText = rules.length;
            
            // Add Stand info if available
            const statsGrid = document.getElementById('docStats');
            const standDivId = 'docStandContainer';
            let standDiv = document.getElementById(standDivId);
            if (!standDiv) {
                standDiv = document.createElement('div');
                standDiv.id = standDivId;
                standDiv.className = 'bg-white p-3 rounded-lg border border-gray-100';
                statsGrid.appendChild(standDiv);
            }
            standDiv.innerHTML = `
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Stand / Herausgeber</div>
                <div class="text-xs font-serif">${d.stand || '--'} / ${d.herausgeber || '--'}</div>
            `;

            const list = document.getElementById('rulesList');
            if (rules.length === 0) {
                list.innerHTML = `<div class="text-center py-12 text-gray-400 italic font-serif">Keine spezifischen Regeln für dieses Dokument extrahiert.</div>`;
            } else {
                // Group rules by context/heading
                const grouped = {};
                rules.forEach(r => {
                    const ctx = r.context || "Allgemein";
                    if (!grouped[ctx]) grouped[ctx] = [];
                    grouped[ctx].push(r);
                });

                list.innerHTML = Object.entries(grouped).map(([ctx, ctxRules]) => `
                    <div class="mb-8">
                        <h4 class="text-[10px] font-bold text-accent-slate uppercase tracking-widest mb-4 border-b pb-2">${ctx}</h4>
                        <div class="space-y-4">
                            ${ctxRules.map(r => `
                                <div class="rule-card bg-federal-50/30 p-4 rounded-r-xl border border-federal-100/50">
                                    <span class="inline-block text-[9px] font-bold px-1.5 py-0.5 rounded bg-federal-100 text-federal-700 uppercase mb-2">${r.category}</span>
                                    <p class="text-sm text-federal-900 leading-relaxed font-sans">${r.rule}</p>
                                    ${r.value ? `<div class="mt-2 text-xs font-semibold text-federal-600">Wert: ${r.value}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // Highlight in graph
            d3.selectAll(".node").classed("highlight-neighbor", n => n.id === d.id);
        }

        function zoomToResults(ids) {
            const idSet = new Set(ids);
            const targetNodes = d3.selectAll(".node").filter(d => idSet.has(d.id));
            
            if (targetNodes.empty()) return;
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            targetNodes.each(d => {
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });
            
            const dx = maxX - minX || 100,
                  dy = maxY - minY || 100,
                  x = (minX + maxX) / 2,
                  y = (minY + maxY) / 2,
                  scale = Math.max(0.1, Math.min(2.5, 0.8 / Math.max(dx / width, dy / height))); // Max zoom 2.5
            
            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(scale)
                .translate(-x, -y);
                
            svg.transition().duration(1000).call(zoom.transform, transform);
            
            // Highlight these nodes visually
            d3.selectAll(".node").classed("dimmed", true); // Dim all
            targetNodes.classed("dimmed", false); // Undim targets
            targetNodes.classed("highlight-neighbor", true); // Highlight
        }

        async function performHybridSearch(query) {
            if (!query) {
                applyFilters();
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            const list = document.getElementById('resultsList');
            resultsDiv.classList.remove('hidden');
            list.innerHTML = '<div class="text-center py-4 font-serif italic text-gray-500">Suche läuft...</div>';
            
            try {
                let url = `/api/search?q=${encodeURIComponent(query)}`;
                const min = document.getElementById('filterMinistry').value;
                const type = document.getElementById('filterType').value;
                const date = document.getElementById('filterDateStart').value;
                
                if (min) url += `&ministerium=${min}`;
                if (type) url += `&kuerzel=${type}`;
                if (date) url += `&stand_after=${date}`;

                const response = await fetch(url);
                const data = await response.json();
                
                const results = Array.isArray(data) ? data : (data.results || []);
                const answer = data.answer || null;
                
                if (results.length === 0) {
                    list.innerHTML = '<div class="text-center py-4 font-serif italic text-gray-500">Keine Ergebnisse gefunden.</div>';
                    return;
                }
                
                // Auto-Zoom to results
                const resultIds = results.map(r => r.id);
                // Also include neighbor IDs? Maybe too cluttered.
                zoomToResults(resultIds);

                let html = '';
                if (answer) {
                    html += `
                        <div class="p-4 bg-federal-900 text-white rounded-2xl mb-4 shadow-lg border-l-4 border-accent-gold">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-4 h-4 text-accent-gold" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 10-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1a1 1 0 112 0v1a1 1 0 11-2 0zM13.536 13.536a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM6.464 16.464a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414l.707-.707z"></path></svg>
                                <span class="text-[10px] font-bold uppercase tracking-widest">Answer Engine</span>
                            </div>
                            <p class="text-sm font-serif italic">${answer}</p>
                        </div>
                    `;
                }
                
                html += results.map(res => `
                    <div class="p-4 bg-white border border-gray-100 rounded-2xl hover:border-federal-300 transition-all cursor-pointer group shadow-sm hover:shadow-md"
                         onclick="highlightResult('${res.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-federal-500 uppercase tracking-tight">${res.herausgeber ? res.herausgeber.toUpperCase() : (res.ministerium ? res.ministerium.toUpperCase() : 'Unbekannt')}</span>
                                <span class="text-[10px] text-gray-400 font-sans">${res.doc_title || 'Unbekannt'}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] font-bold text-accent-gold bg-gold/10 px-2 py-0.5 rounded-full">${Math.round(res.score * 100)}% Match</span>
                                ${res.stand ? `<span class="text-[9px] text-gray-400 mt-1">Stand: ${res.stand}</span>` : ''}
                            </div>
                        </div>
                        <h4 class="text-base font-semibold text-federal-900 mb-2 leading-tight">
                            ${res.kuerzel ? `<span class="text-federal-700">[${res.kuerzel}]</span> ` : ''}
                            ${res.breadcrumbs || 'Hauptdokument'}
                        </h4>
                        <p class="text-sm text-gray-600 line-clamp-3 font-sans mb-4">${res.text}</p>
                        
                        ${res.rules && res.rules.length > 0 ? `
                            <div class="space-y-2 mt-4 pt-4 border-t border-gray-50">
                                <div class="text-[10px] font-bold text-federal-400 uppercase tracking-widest mb-2">Extrahierte Regeln</div>
                                ${res.rules.map(rule => `
                                    <div class="p-3 bg-federal-50/50 rounded-xl border border-federal-100/50 rule-card">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-[9px] font-bold text-federal-700 uppercase px-1.5 py-0.5 bg-federal-100 rounded">${rule.category}</span>
                                            ${rule.value ? `<span class="text-[9px] font-semibold text-federal-600">${rule.value}</span>` : ''}
                                        </div>
                                        <p class="text-xs text-federal-800 leading-snug">${rule.rule}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${res.neighbor_context && res.neighbor_context.length > 0 ? `
                            <div class="mt-4 pt-4 border-t border-gray-50">
                                <details class="group/context">
                                    <summary class="text-[10px] font-bold text-federal-400 uppercase tracking-widest cursor-pointer hover:text-federal-600 flex items-center gap-1 list-none">
                                        <svg class="w-3 h-3 transition-transform group-open/context:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="3" d="M9 5l7 7-7 7"/></svg>
                                        Graph-Kontext (+${res.neighbor_context.length} Nachbarn)
                                    </summary>
                                    <div class="mt-2 space-y-2">
                                        ${res.neighbor_context.slice(0, 5).map(nb => {
                                            let containerClass = "text-[10px] p-2.5 rounded-lg border-l-2 transition-all hover:shadow-sm ";
                                            let icon = '';
                                            let typeLabel = '';
                                            
                                            if (nb.type === 'warning') {
                                                containerClass += "bg-red-50/80 border-red-500 text-red-900";
                                                icon = `<svg class="w-3 h-3 text-red-600 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
                                                typeLabel = '<span class="text-[8px] font-bold uppercase tracking-tighter text-red-600 mb-1 block flex items-center gap-1">Achtung: Dokument überholt</span>';
                                            } else if (nb.type === 'reference') {
                                                containerClass += "bg-amber-50/80 border-accent-gold text-federal-800";
                                                icon = `<svg class="w-3 h-3 text-accent-gold inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>`;
                                                typeLabel = '<span class="text-[8px] font-bold uppercase tracking-tighter text-accent-gold mb-1 block flex items-center gap-1">Verknüpfte Referenz</span>';
                                            } else {
                                                containerClass += "bg-gray-50/50 border-gray-200 text-gray-500 italic";
                                                typeLabel = '<span class="text-[8px] font-bold uppercase tracking-tighter text-gray-400 mb-1 block">Zugehöriger Kontext</span>';
                                            }

                                            return `
                                                <div class="${containerClass}">
                                                    ${typeLabel}
                                                    <span class="font-semibold block mb-0.5 text-federal-900 not-italic flex items-center gap-1">
                                                        ${icon}
                                                        ${nb.breadcrumbs || 'Unbekannter Abschnitt'}
                                                    </span>
                                                    <div class="line-clamp-2 leading-snug">${nb.text}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                list.innerHTML = html;
            } catch (error) {
                console.error("Hybrid search error:", error);
                list.innerHTML = '<div class="text-center py-4 text-red-500 text-xs">Fehler bei der Suche. Ist die API gestartet?</div>';
            }
        }

        function updateFilterOptions() {
            const currentMin = document.getElementById('filterMinistry').value.trim().toLowerCase();
            const currentType = document.getElementById('filterType').value.trim().toLowerCase();
            const currentCat = document.getElementById('filterCategory').value;
            
            // Sets of valid options given the OTHER filter
            const validMinistries = new Set();
            const validTypes = new Set();
            
            graphData.nodes.forEach(n => {
                // Check Category Filter for Dependency Logic
                // If I have selected Category 'law', only show Ministries/Types that have laws
                let matchesCat = true;
                if (currentCat) {
                    const isLaw = (n.type === 'law' || n.node_type === 'law');
                    if (currentCat === 'law' && !isLaw) matchesCat = false;
                    if (currentCat === 'document' && isLaw) matchesCat = false;
                }
                
                if (!matchesCat) return;

                const nodeMin = (n.ministerium || "").trim();
                const nodeIss = (n.herausgeber || "").trim();
                const nodeType = (n.kuerzel || "").trim();
                
                const nodeMinLower = nodeMin.toLowerCase();
                const nodeIssLower = nodeIss.toLowerCase();
                const nodeTypeLower = nodeType.toLowerCase();
                
                // 1. Check if this node contributes to valid Types (matches current Min)
                let matchesMin = true;
                if (currentMin) {
                    if (!nodeMinLower.includes(currentMin) && !nodeIssLower.includes(currentMin)) matchesMin = false;
                }
                if (matchesMin && nodeType) validTypes.add(nodeType);
                
                // 2. Check if this node contributes to valid Ministries (matches current Type)
                let matchesType = true;
                if (currentType) {
                    if (!nodeTypeLower.includes(currentType)) matchesType = false;
                }
                if (matchesType) {
                    if (nodeMin && nodeMin.toLowerCase() !== "unbekannt") validMinistries.add(nodeMin);
                    if (nodeIss && nodeIss.toLowerCase() !== "unbekannt") validMinistries.add(nodeIss);
                }
            });
            
            // Update Ministry Options
            const minSelect = document.getElementById('filterMinistry');
            Array.from(minSelect.options).forEach(opt => {
                if (opt.value === "") return;
                const isValid = validMinistries.has(opt.value);
                opt.disabled = !isValid;
                opt.style.color = isValid ? '' : '#d1d5db';
            });
            
            // Update Type Options
            const typeSelect = document.getElementById('filterType');
            Array.from(typeSelect.options).forEach(opt => {
                if (opt.value === "") return;
                const isValid = validTypes.has(opt.value);
                opt.disabled = !isValid;
                opt.style.color = isValid ? '' : '#d1d5db';
            });
        }

        function handleCategoryChange() {
            const cat = document.getElementById('filterCategory').value;
            if (cat === 'law') {
                document.getElementById('filterMinistry').value = "";
                document.getElementById('filterType').value = "";
                document.getElementById('filterDateStart').value = "";
            }
            applyFilters();
        }

        function applyFilters(shouldZoom = true) {
            const min = document.getElementById('filterMinistry').value.trim().toLowerCase();
            const type = document.getElementById('filterType').value.trim().toLowerCase();
            const date = document.getElementById('filterDateStart').value;
            const cat = document.getElementById('filterCategory').value;
            
            d3.selectAll(".node").classed("dimmed", n => !isNodeVisible(n, min, type, date, cat));
            
            // Update links
            d3.selectAll(".link").classed("dimmed", function(d) {
                const sourceDimmed = !isNodeVisible(d.source, min, type, date, cat);
                const targetDimmed = !isNodeVisible(d.target, min, type, date, cat);
                return sourceDimmed || targetDimmed;
            });
            
            updateFilterOptions();
            
            const query = document.getElementById('hybridSearchInput').value;
            if (query) {
                performHybridSearch(query);
            } else if (shouldZoom) {
                zoomToVisible();
            }
        }
        
        function isNodeVisible(n, min, type, date, cat) {
            if (cat) {
                const isLaw = (n.type === 'law' || n.node_type === 'law');
                if (cat === 'law' && !isLaw) return false;
                if (cat === 'document' && isLaw) return false;
            }
            if (min) {
                const nodeMin = (n.ministerium || "").trim().toLowerCase();
                const nodeIss = (n.herausgeber || "").trim().toLowerCase();
                if (!nodeMin.includes(min) && !nodeIss.includes(min)) return false;
            }
            if (type && (!n.kuerzel || !n.kuerzel.trim().toLowerCase().includes(type))) return false;
            if (date && n.stand && n.stand < date) return false;
            return true;
        }

        function clearFilters() {
            document.getElementById('filterCategory').value = "";
            document.getElementById('filterMinistry').value = "";
            document.getElementById('filterType').value = "";
            document.getElementById('filterDateStart').value = "";
            applyFilters();
        }

        function highlightResult(nodeId) {
            // Node in D3 graph might be different if it's not a doc node
            // But we can try to find the document it belongs to
            const docId = nodeId.split('_')[0];
            const node = graphData.nodes.find(n => n.id === docId);
            if (node) {
                selectNode(node);
                // Center graph on node
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(1.5).translate(-node.x, -node.y)
                );
            }
        }

        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const arrow = document.getElementById('filterArrow');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        function handleSearch(query) {
            if (!query) {
                d3.selectAll(".node").classed("dimmed", false);
                return;
            }

            const q = query.toLowerCase();
            const matchingDocIds = new Set();

            // Check doc titles
            graphData.nodes.forEach(n => {
                if (n.title.toLowerCase().includes(q) || n.id.toLowerCase().includes(q)) {
                    matchingDocIds.add(n.id);
                }
            });

            // Check rules
            Object.entries(documentRules).forEach(([docId, rules]) => {
                if (rules.some(r => r.rule.toLowerCase().includes(q) || r.category.toLowerCase().includes(q))) {
                    matchingDocIds.add(docId);
                }
            });

            d3.selectAll(".node").classed("dimmed", n => !matchingDocIds.has(n.id));
        }

        function closeSidebar() {
            // Optional: add transition to hide sidebar
        }

        function toggleInfo() {
            const modal = document.getElementById('infoModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // Initialize
        loadData();

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth * 0.66;
            const newHeight = window.innerHeight;
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>
