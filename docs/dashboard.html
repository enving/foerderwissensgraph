<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bund-ZuwendungsGraph | Interactive Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,600;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Instrument Sans"', 'sans-serif'],
                        serif: ['"Instrument Serif"', 'serif'],
                    },
                    colors: {
                        federal: {
                            900: '#001A33',
                            800: '#002244',
                            700: '#003366',
                            600: '#004488',
                            500: '#0055AA',
                        },
                        accent: {
                            gold: '#D4AF37',
                            slate: '#64748b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f9fafb;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3%3Cfilter id='noiseFilter'%3%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-blend-mode: overlay;
            opacity: 0.98;
        }

        .graph-container {
            cursor: grab;
        }
        .graph-container:active {
            cursor: grabbing;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.2s ease;
        }
        .node:hover {
            stroke: #000;
            stroke-width: 3px;
        }

        .link {
            stroke: #cbd5e1;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            fill: none;
            transition: all 0.2s ease;
        }

        .link.supersedes {
            stroke: #ef4444;
            stroke-dasharray: 4, 4;
        }

        .highlight-neighbor {
            stroke: #003366 !important;
            stroke-width: 3px !important;
        }

        .dimmed {
            opacity: 0.2;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        #tooltip {
            pointer-events: none;
            z-index: 50;
        }

        .rule-card {
            border-left: 3px solid #003366;
        }
    </style>
</head>
<body class="h-screen overflow-hidden text-federal-900 selection:bg-federal-100">

    <div class="flex h-full">
        <!-- Main Content: Graph -->
        <main class="relative flex-1 bg-white/50 backdrop-blur-sm overflow-hidden">
            <!-- Header Overlay -->
            <div class="absolute top-6 left-8 z-10 pointer-events-none">
                <h1 class="text-4xl font-serif italic mb-1">Bund-ZuwendungsGraph</h1>
                <p class="text-accent-slate text-sm font-sans tracking-wide uppercase">Interactive Document Intelligence Dashboard</p>
            </div>

            <!-- Controls Overlay -->
            <div class="absolute bottom-8 left-8 z-10 flex flex-col gap-4">
                <div class="bg-white/80 backdrop-blur-md p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3 pointer-events-auto">
                    <div class="text-xs font-semibold text-federal-700 uppercase tracking-tighter">Legend</div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full bg-federal-700"></span>
                        <span>Dokument</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-8 h-0 border-t-2 border-dashed border-red-500"></span>
                        <span>SUPERSEDES</span>
                    </div>
                </div>
                
                <div class="bg-white/80 backdrop-blur-md p-2 rounded-xl border border-gray-200 shadow-sm flex gap-2 pointer-events-auto">
                    <button onclick="zoomIn()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button onclick="zoomOut()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button onclick="resetZoom()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Reset">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><polyline points="3 3 3 8 8 8"></polyline></svg>
                    </button>
                </div>
            </div>

            <!-- Search Overlay -->
            <div class="absolute top-6 right-8 z-10 w-96">
                <div class="relative group pointer-events-auto">
                    <input type="text" id="hybridSearchInput" placeholder="Hybrid Search (ChromaDB + Graph)..." 
                        class="w-full bg-white/90 backdrop-blur-md border border-gray-200 rounded-full px-5 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-federal-500 focus:border-transparent shadow-sm transition-all group-hover:shadow-md"
                        onkeydown="if(event.key === 'Enter') performHybridSearch(this.value)">
                    <button onclick="performHybridSearch(document.getElementById('hybridSearchInput').value)" class="absolute right-4 top-1/2 -translate-y-1/2 text-federal-600 hover:text-federal-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </div>
                <div id="searchResults" class="hidden mt-4 bg-white/95 backdrop-blur-md rounded-2xl border border-gray-200 shadow-xl overflow-hidden pointer-events-auto max-h-[70vh] flex flex-col">
                    <div class="p-3 bg-federal-50 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-federal-700">Suchergebnisse</span>
                        <button onclick="document.getElementById('searchResults').classList.add('hidden')" class="text-gray-400 hover:text-federal-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div id="resultsList" class="overflow-y-auto sidebar-scroll p-4 space-y-4">
                        <!-- Results injected here -->
                    </div>
                </div>
            </div>

            <!-- SVG Container -->
            <svg id="graph" class="w-full h-full graph-container"></svg>
            
            <!-- Tooltip -->
            <div id="tooltip" class="absolute hidden bg-federal-900 text-white px-3 py-2 rounded-lg text-xs shadow-xl max-w-xs transition-opacity duration-200"></div>
        </main>

        <!-- Right Sidebar -->
        <aside id="sidebar" class="w-1/3 bg-white border-l border-gray-200 shadow-2xl flex flex-col z-20">
            <div class="p-8 border-b border-gray-100 bg-gray-50/50">
                <div class="flex justify-between items-start mb-4">
                    <span id="docCategory" class="text-[10px] font-bold tracking-widest uppercase text-federal-500 px-2 py-1 bg-federal-50 rounded">Kategorie</span>
                    <button onclick="closeSidebar()" class="text-gray-400 hover:text-federal-900 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <h2 id="docTitle" class="text-2xl font-serif leading-tight mb-2">Wählen Sie ein Dokument aus</h2>
                <div id="docKuerzel" class="text-xs text-federal-600 font-bold mb-4"></div>
                <div class="flex flex-wrap gap-2 mb-6">
                    <a id="docLink" href="#" target="_blank" class="text-xs flex items-center gap-1.5 text-federal-600 hover:text-federal-800 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        PDF Dokument öffnen
                    </a>
                </div>
                <div id="docStats" class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Regeln</div>
                        <div id="ruleCount" class="text-xl font-serif">0</div>
                    </div>
                    <div id="docIdContainer" class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">ID</div>
                        <div id="docId" class="text-xl font-serif">--</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto sidebar-scroll p-8">
                <h3 class="text-sm font-bold uppercase tracking-widest text-federal-800 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Extrahierte Regeln
                </h3>
                <div id="rulesList" class="space-y-6">
                    <!-- Rules will be injected here -->
                    <div class="text-center py-12 text-gray-400 italic font-serif">
                        Keine Regeln ausgewählt
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Data management
        let graphData = null;
        let knowledgeData = null;
        let documentRules = {}; // docId -> list of rules

        const svg = d3.select("#graph");
        const width = window.innerWidth * 0.66;
        const height = window.innerHeight;
        
        const g = svg.append("g");
        
        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => g.attr("transform", event.transform));

        svg.call(zoom);

        function zoomIn() { svg.transition().call(zoom.scaleBy, 1.3); }
        function zoomOut() { svg.transition().call(zoom.scaleBy, 0.7); }
        function resetZoom() { svg.transition().call(zoom.transform, d3.zoomIdentity); }

        // Simulation
        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(60));

        // Load Data
        async function loadData() {
            try {
                const [docsResponse, knowledgeResponse] = await Promise.all([
                    fetch('../data/d3_graph_documents.json'),
                    fetch('../data/knowledge_graph.json')
                ]);

                graphData = await docsResponse.json();
                knowledgeData = await knowledgeResponse.json();

                processRules();
                renderGraph();
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Fehler beim Laden der Daten. Bitte stellen Sie sicher, dass Sie die Datei über einen Webserver öffnen.");
            }
        }

        function processRules() {
            knowledgeData.nodes.forEach(node => {
                if (node.type === 'chunk' && node.rules && node.rules.length > 0) {
                    const docId = node.id.split('_')[0];
                    if (!documentRules[docId]) documentRules[docId] = [];
                    
                    node.rules.forEach(rule => {
                        documentRules[docId].push({
                            ...rule,
                            context: node.context,
                            headings: node.headings
                        });
                    });
                }
            });
        }

        function renderGraph() {
            const nodes = graphData.nodes;
            const links = graphData.links;

            // Define arrowheads
            svg.append("defs").selectAll("marker")
                .data(["SUPERSEDES", "default"])
                .enter().append("marker")
                .attr("id", d => `arrow-${d}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("fill", d => d === "SUPERSEDES" ? "#ef4444" : "#cbd5e1")
                .attr("d", "M0,-5L10,0L0,5");

            const linkElements = g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(links)
                .enter().append("path")
                .attr("class", d => `link ${d.relation?.toLowerCase() || ''}`)
                .attr("marker-end", d => `url(#arrow-${d.relation === "SUPERSEDES" ? "SUPERSEDES" : "default"})`);

            const nodeElements = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 12)
                .attr("fill", d => "#003366")
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", (e, d) => selectNode(d))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            const labels = g.append("g")
                .attr("class", "labels")
                .selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "text-[8px] font-sans fill-federal-500 pointer-events-none")
                .attr("dy", 24)
                .attr("text-anchor", "middle")
                .text(d => d.title.length > 25 ? d.title.substring(0, 22) + "..." : d.title);

            simulation.nodes(nodes).on("tick", () => {
                linkElements.attr("d", d => {
                    const dx = d.target.x - d.source.x,
                          dy = d.target.y - d.source.y,
                          dr = Math.sqrt(dx * dx + dy * dy);
                    // Use arcs for superseded links to distinguish
                    if (d.relation === "SUPERSEDES") {
                        return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                    }
                    return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
                });

                nodeElements
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            simulation.force("link").links(links);
        }

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tooltip
        const tooltip = d3.select("#tooltip");
        function showTooltip(event, d) {
            tooltip.style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px")
                .html(`
                    <div class="font-bold mb-1">${d.title}</div>
                    <div class="opacity-70">${d.category}</div>
                `);
            
            // Highlight neighbors
            const neighbors = new Set();
            graphData.links.forEach(l => {
                if (l.source.id === d.id) neighbors.add(l.target.id);
                if (l.target.id === d.id) neighbors.add(l.source.id);
            });

            d3.selectAll(".node").classed("dimmed", n => n.id !== d.id && !neighbors.has(n.id));
            d3.selectAll(".link").classed("dimmed", l => l.source.id !== d.id && l.target.id !== d.id);
        }

        function hideTooltip() {
            tooltip.style("display", "none");
            d3.selectAll(".node").classed("dimmed", false);
            d3.selectAll(".link").classed("dimmed", false);
        }

        // Sidebar & Interaction
        function selectNode(d) {
            document.getElementById('docTitle').innerText = d.title;
            document.getElementById('docKuerzel').innerText = d.kuerzel ? `[${d.kuerzel}]` : '';
            const categoryText = d.ministerium ? `${d.ministerium.toUpperCase()} | ${d.category}` : d.category;
            document.getElementById('docCategory').innerText = categoryText;
            document.getElementById('docId').innerText = d.id;
            document.getElementById('docLink').href = d.url;

            const rules = documentRules[d.id] || [];
            document.getElementById('ruleCount').innerText = rules.length;
            
            // Add Stand info if available
            const statsGrid = document.getElementById('docStats');
            const standDivId = 'docStandContainer';
            let standDiv = document.getElementById(standDivId);
            if (!standDiv) {
                standDiv = document.createElement('div');
                standDiv.id = standDivId;
                standDiv.className = 'bg-white p-3 rounded-lg border border-gray-100';
                statsGrid.appendChild(standDiv);
            }
            standDiv.innerHTML = `
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Stand / Herausgeber</div>
                <div class="text-xs font-serif">${d.stand || '--'} / ${d.herausgeber || '--'}</div>
            `;

            const list = document.getElementById('rulesList');
            if (rules.length === 0) {
                list.innerHTML = `<div class="text-center py-12 text-gray-400 italic font-serif">Keine spezifischen Regeln für dieses Dokument extrahiert.</div>`;
            } else {
                // Group rules by context/heading
                const grouped = {};
                rules.forEach(r => {
                    const ctx = r.context || "Allgemein";
                    if (!grouped[ctx]) grouped[ctx] = [];
                    grouped[ctx].push(r);
                });

                list.innerHTML = Object.entries(grouped).map(([ctx, ctxRules]) => `
                    <div class="mb-8">
                        <h4 class="text-[10px] font-bold text-accent-slate uppercase tracking-widest mb-4 border-b pb-2">${ctx}</h4>
                        <div class="space-y-4">
                            ${ctxRules.map(r => `
                                <div class="rule-card bg-federal-50/30 p-4 rounded-r-xl border border-federal-100/50">
                                    <span class="inline-block text-[9px] font-bold px-1.5 py-0.5 rounded bg-federal-100 text-federal-700 uppercase mb-2">${r.category}</span>
                                    <p class="text-sm text-federal-900 leading-relaxed font-sans">${r.rule}</p>
                                    ${r.value ? `<div class="mt-2 text-xs font-semibold text-federal-600">Wert: ${r.value}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // Highlight in graph
            d3.selectAll(".node").classed("highlight-neighbor", n => n.id === d.id);
        }

        async function performHybridSearch(query) {
            if (!query) return;
            
            const resultsDiv = document.getElementById('searchResults');
            const list = document.getElementById('resultsList');
            resultsDiv.classList.remove('hidden');
            list.innerHTML = '<div class="text-center py-4 font-serif italic text-gray-500">Suche läuft...</div>';
            
            try {
                const response = await fetch(`http://localhost:5001/api/search?q=${encodeURIComponent(query)}`);
                const results = await response.json();
                
                if (results.length === 0) {
                    list.innerHTML = '<div class="text-center py-4 font-serif italic text-gray-500">Keine Ergebnisse gefunden.</div>';
                    return;
                }
                
                list.innerHTML = results.map(res => `
                    <div class="p-4 bg-white border border-gray-100 rounded-2xl hover:border-federal-300 transition-all cursor-pointer group shadow-sm hover:shadow-md"
                         onclick="highlightResult('${res.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-federal-500 uppercase tracking-tight">${res.herausgeber ? res.herausgeber.toUpperCase() : (res.ministerium ? res.ministerium.toUpperCase() : 'Unbekannt')}</span>
                                <span class="text-[10px] text-gray-400 font-sans">${res.doc_title || 'Unbekannt'}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] font-bold text-accent-gold bg-gold/10 px-2 py-0.5 rounded-full">${Math.round(res.score * 100)}% Match</span>
                                ${res.stand ? `<span class="text-[9px] text-gray-400 mt-1">Stand: ${res.stand}</span>` : ''}
                            </div>
                        </div>
                        <h4 class="text-base font-semibold text-federal-900 mb-2 leading-tight">
                            ${res.kuerzel ? `<span class="text-federal-700">[${res.kuerzel}]</span> ` : ''}
                            ${res.breadcrumbs || 'Hauptdokument'}
                        </h4>
                        <p class="text-sm text-gray-600 line-clamp-3 font-sans mb-4">${res.text}</p>
                        
                        ${res.rules && res.rules.length > 0 ? `
                            <div class="space-y-2 mt-4 pt-4 border-t border-gray-50">
                                <div class="text-[10px] font-bold text-federal-400 uppercase tracking-widest mb-2">Extrahierte Regeln</div>
                                ${res.rules.map(rule => `
                                    <div class="p-3 bg-federal-50/50 rounded-xl border border-federal-100/50 rule-card">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-[9px] font-bold text-federal-700 uppercase px-1.5 py-0.5 bg-federal-100 rounded">${rule.category}</span>
                                            ${rule.value ? `<span class="text-[9px] font-semibold text-federal-600">${rule.value}</span>` : ''}
                                        </div>
                                        <p class="text-xs text-federal-800 leading-snug">${rule.rule}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${res.neighbor_context && res.neighbor_context.length > 0 ? `
                            <div class="mt-4 pt-4 border-t border-gray-50">
                                <details class="group/context">
                                    <summary class="text-[10px] font-bold text-federal-400 uppercase tracking-widest cursor-pointer hover:text-federal-600 flex items-center gap-1 list-none">
                                        <svg class="w-3 h-3 transition-transform group-open/context:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="3" d="M9 5l7 7-7 7"/></svg>
                                        Graph-Kontext (+${res.neighbor_context.length} Nachbarn)
                                    </summary>
                                    <div class="mt-2 space-y-2">
                                        ${res.neighbor_context.slice(0, 3).map(nb => `
                                            <div class="text-[10px] text-gray-500 italic p-2 bg-gray-50/50 rounded-lg border-l-2 border-gray-200">
                                                <span class="font-semibold block mb-0.5">${nb.breadcrumbs}</span>
                                                ${nb.text}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error("Hybrid search error:", error);
                list.innerHTML = '<div class="text-center py-4 text-red-500 text-xs">Fehler bei der Suche. Ist die API gestartet?</div>';
            }
        }

        function highlightResult(nodeId) {
            // Node in D3 graph might be different if it's not a doc node
            // But we can try to find the document it belongs to
            const docId = nodeId.split('_')[0];
            const node = graphData.nodes.find(n => n.id === docId);
            if (node) {
                selectNode(node);
                // Center graph on node
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(1.5).translate(-node.x, -node.y)
                );
            }
        }

        function handleSearch(query) {
            if (!query) {
                d3.selectAll(".node").classed("dimmed", false);
                return;
            }

            const q = query.toLowerCase();
            const matchingDocIds = new Set();

            // Check doc titles
            graphData.nodes.forEach(n => {
                if (n.title.toLowerCase().includes(q) || n.id.toLowerCase().includes(q)) {
                    matchingDocIds.add(n.id);
                }
            });

            // Check rules
            Object.entries(documentRules).forEach(([docId, rules]) => {
                if (rules.some(r => r.rule.toLowerCase().includes(q) || r.category.toLowerCase().includes(q))) {
                    matchingDocIds.add(docId);
                }
            });

            d3.selectAll(".node").classed("dimmed", n => !matchingDocIds.has(n.id));
        }

        function closeSidebar() {
            // Optional: add transition to hide sidebar
        }

        // Initialize
        loadData();

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth * 0.66;
            const newHeight = window.innerHeight;
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>
