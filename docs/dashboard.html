<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Förderwissensgraph | Interactive Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,600;1,400&family=Instrument+Serif:ital@0;1&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Instrument Sans"', 'sans-serif'],
                        serif: ['"Instrument Serif"', 'serif'],
                    },
                    colors: {
                        federal: {
                            900: '#001A33',
                            800: '#002244',
                            700: '#003366',
                            600: '#004488',
                            500: '#0055AA',
                        },
                        accent: {
                            gold: '#D4AF37',
                            slate: '#64748b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f9fafb;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3%3Cfilter id='noiseFilter'%3%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-blend-mode: overlay;
            opacity: 0.98;
        }

        .graph-container {
            cursor: grab;
        }

        .graph-container:active {
            cursor: grabbing;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.2s ease;
        }

        .node:hover {
            stroke: #000;
            stroke-width: 3px;
        }

        .link {
            stroke: #cbd5e1;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            fill: none;
            transition: all 0.2s ease;
        }

        .link.supersedes {
            stroke: #ef4444;
            stroke-dasharray: 4, 4;
        }

        .highlight-neighbor {
            stroke: #003366 !important;
            stroke-width: 3px !important;
        }

        .dimmed {
            opacity: 0.05;
            pointer-events: none;
            /* Make dimmed nodes unclickable */
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        #tooltip {
            pointer-events: none;
            z-index: 50;
        }

        .rule-card {
            border-left: 3px solid #003366;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="h-screen overflow-hidden text-federal-900 selection:bg-federal-100">

    <div class="flex h-full">
        <!-- Main Content: Graph -->
        <main class="relative flex-1 bg-white/50 backdrop-blur-sm overflow-hidden">
            <!-- Header Overlay -->
            <div class="absolute top-6 left-8 z-10 pointer-events-none flex items-start gap-3">
                <div>
                    <h1 class="text-4xl font-serif italic mb-1">Förderwissensgraph</h1>
                    <p class="text-accent-slate text-sm font-sans tracking-wide uppercase">Interactive Document
                        Intelligence Dashboard</p>
                </div>
                <button onclick="toggleInfo()"
                    class="pointer-events-auto mt-2 p-1.5 bg-white/50 backdrop-blur rounded-full text-federal-600 hover:text-federal-900 hover:bg-white transition-all shadow-sm border border-federal-100"
                    title="Über das Projekt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </button>
            </div>

            <!-- Info Modal -->
            <div id="infoModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-federal-900/40 backdrop-blur-sm p-4 transition-opacity duration-300">
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full relative overflow-hidden flex flex-col max-h-[90vh]"
                    onclick="event.stopPropagation()">

                    <!-- Decor element -->
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-accent-gold/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
                    </div>

                    <div class="p-8 pb-4 border-b border-gray-100 flex justify-between items-start bg-gray-50/50">
                        <div>
                            <h2 class="text-2xl font-serif text-federal-900 mb-1">Über den Förderwissensgraph</h2>
                            <p class="text-sm text-gray-500 font-sans">Ein Projekt zur Digitalisierung des
                                Fördermittel-Managements</p>
                        </div>
                        <button onclick="toggleInfo()"
                            class="text-gray-400 hover:text-federal-900 transition-colors p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div class="p-8 overflow-y-auto space-y-8 font-sans">
                        <!-- Section 1: The Graph -->
                        <div class="flex gap-4">
                            <div
                                class="flex-shrink-0 w-10 h-10 rounded-full bg-federal-100 flex items-center justify-center text-federal-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="18" cy="5" r="3"></circle>
                                    <circle cx="6" cy="12" r="3"></circle>
                                    <circle cx="18" cy="19" r="3"></circle>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">High-Density Knowledge Graph</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Dieses Dashboard visualisiert nicht nur Dokumente, sondern deren
                                    <strong>Beziehungen</strong>. Es erkennt automatisch Referenzen (z.B. "siehe
                                    BNBest-P") und Versionierungen ("ersetzt durch").
                                    <br><span class="text-xs text-federal-500 mt-1 block">Technologie: NetworkX, D3.js,
                                        Docling PDF Parser</span>
                                </p>
                            </div>
                        </div>

                        <!-- Section 2: Hybrid Search -->
                        <div class="flex gap-4">
                            <div
                                class="flex-shrink-0 w-10 h-10 rounded-full bg-accent-gold/10 flex items-center justify-center text-accent-gold">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">Graph-Guided RAG</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Unsere Suche nutzt <strong>Hybrid Retrieval</strong> (Vektor + Keyword) und
                                    erweitert den Kontext über den Graphen ("Multi-Hop"). So kann die KI Fragen
                                    beantworten, die Wissen aus mehreren verknüpften Dokumenten erfordern.
                                    <br><span class="text-xs text-federal-500 mt-1 block">Technologie: ChromaDB, BM25,
                                        Cross-Encoder Reranking</span>
                                </p>
                            </div>
                        </div>

                        <!-- Section 3: API -->
                        <div class="flex gap-4">
                            <div
                                class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="16 18 22 12 16 6"></polyline>
                                    <polyline points="8 6 2 12 8 18"></polyline>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-federal-800 mb-2">Open API Schnittstelle</h3>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    Das gesamte System ist "API-First" gebaut. Entwickler können den Graphen, die Suche
                                    und die KI-Antworten direkt in eigene Anwendungen integrieren.
                                </p>
                                <a href="/api/docs" target="_blank"
                                    class="inline-flex items-center gap-1 mt-2 text-xs font-bold text-federal-600 hover:text-federal-800 border border-federal-200 px-3 py-1.5 rounded-lg hover:bg-federal-50 transition-colors">
                                    API Dokumentation öffnen
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div
                        class="p-6 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-xs text-gray-400">
                        <span>Version 2.4.0</span>
                        <button onclick="toggleInfo()"
                            class="px-4 py-2 bg-federal-900 text-white rounded-lg hover:bg-federal-800 font-bold transition-colors">Schließen</button>
                    </div>
                </div>
            </div>

            <!-- Controls Overlay -->
            <div class="absolute bottom-8 left-8 z-10 flex flex-col gap-4">
                <!-- Filter Panel -->
                <div
                    class="bg-white/80 backdrop-blur-md rounded-xl border border-gray-200 shadow-sm overflow-hidden w-64 pointer-events-auto">
                    <button onclick="toggleFilters()"
                        class="w-full flex items-center justify-between p-4 text-xs font-semibold text-federal-700 uppercase tracking-tighter hover:bg-gray-50 transition-colors">
                        <span>Filter</span>
                        <svg id="filterArrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300"
                            style="transform: rotate(0deg);">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="filterContent" class="p-4 pt-0 space-y-3">
                        <!-- Category Filter -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Kategorie</label>
                            <select id="filterCategory" onchange="handleCategoryChange()"
                                class="w-full text-xs p-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-federal-200 outline-none">
                                <option value="">Alle</option>
                                <option value="law">Gesetze</option>
                                <option value="document">Dokumente</option>
                            </select>
                        </div>
                        <!-- Ministry Filter -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Ressort /
                                Herausgeber</label>
                            <select id="filterMinistry" onchange="applyFilters()"
                                class="w-full text-xs p-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-federal-200 outline-none">
                                <option value="">Alle Ressorts</option>
                            </select>
                        </div>
                        <!-- Type Filter -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Typ</label>
                            <select id="filterType" onchange="applyFilters()"
                                class="w-full text-xs p-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-federal-200 outline-none">
                                <option value="">Alle Typen</option>
                            </select>
                        </div>
                        <!-- Date Filter -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Stand seit</label>
                            <input type="date" id="filterDateStart" onchange="applyFilters()"
                                class="w-full text-xs p-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-federal-200 outline-none">
                        </div>

                        <!-- Reset Button -->
                        <button onclick="clearFilters()"
                            class="w-full mt-2 py-1.5 text-xs font-bold text-gray-500 hover:text-federal-900 border border-gray-200 rounded hover:bg-white transition-colors">
                            Filter zurücksetzen
                        </button>
                    </div>
                </div>
                <div
                    class="bg-white/80 backdrop-blur-md p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3 pointer-events-auto">
                    <div class="text-xs font-semibold text-federal-700 uppercase tracking-tighter">Legend</div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full bg-federal-700"></span>
                        <span>Formularschrank</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                        <span>Gesetz</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-8 h-0 border-t-2 border-dashed border-red-500"></span>
                        <span>SUPERSEDES</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-8 h-0 border-t-2 border-accent-gold"></span>
                        <span>REFERENZ</span>
                    </div>
                </div>

                <div
                    class="bg-white/80 backdrop-blur-md p-2 rounded-xl border border-gray-200 shadow-sm flex gap-2 pointer-events-auto">
                    <button onclick="zoomIn()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button onclick="zoomOut()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button onclick="resetZoom()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Reset">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                            <polyline points="3 3 3 8 8 8"></polyline>
                        </svg>
                    </button>
                    <button onclick="autoZoom()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Fit to View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat Interface Wrapper -->
            <!-- Using translate-x-full to hide it off-screen to the right. pointer-events-none when hidden to avoid clicks. -->
            <div id="chatWrapper"
                class="absolute top-6 right-8 bottom-8 z-10 w-[400px] flex flex-col pointer-events-none transition-all duration-300 transform translate-x-0 opacity-100"
                data-state="visible">
                <div class="flex-1 bg-white/95 backdrop-blur-xl rounded-2xl border border-gray-200 shadow-2xl overflow-hidden flex flex-col pointer-events-auto"
                    id="chatContainer">

                    <!-- Chat Header -->
                    <div class="p-4 border-b border-gray-100 bg-gray-50/80 flex justify-between items-center cursor-pointer"
                        ondblclick="toggleChat()" title="Doppelklick zum Minimieren">
                        <div>
                            <h2 class="text-sm font-bold uppercase tracking-widest text-federal-800">Graph Assistant
                            </h2>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <span class="text-[10px] text-gray-500 font-medium">Online • RAG Ready</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <!-- Minimize Button -->
                            <button onclick="toggleChat()"
                                class="p-1.5 text-gray-400 hover:text-federal-600 transition-colors"
                                title="Chat minimieren">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white/50 scroll-smooth">
                        <!-- Welcome Message -->
                        <div class="flex gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-federal-100 flex items-center justify-center flex-shrink-0 text-federal-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div class="space-y-1">
                                <div
                                    class="bg-gray-100 p-3 rounded-2xl rounded-tl-none text-sm text-gray-700 shadow-sm border border-gray-200/50">
                                    Hallo! Ich bin dein Assistent für Förderrichtlinien. <br>
                                    Stelle mir Fragen zum Bestand oder <strong>lade eigene Dokumente hoch</strong> (PDF,
                                    DOCX, TXT), um
                                    sie zu analysieren.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload State -->
                    <div id="uploadPreview"
                        class="hidden px-4 py-3 bg-blue-50/80 border-t border-blue-100 flex justify-between items-center backdrop-blur-sm">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div
                                class="w-6 h-6 rounded bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="12" y1="18" x2="12" y2="12"></line>
                                    <line x1="9" y1="15" x2="15" y2="15"></line>
                                </svg>
                            </div>
                            <span class="text-xs text-blue-800 font-medium truncate max-w-[200px]"
                                id="uploadFilename">document.pdf</span>
                        </div>
                        <button onclick="clearUpload()" class="text-blue-400 hover:text-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <!-- Input Area -->
                    <div class="p-3 bg-white border-t border-gray-100 relative">
                        <!-- Drop Zone Overlay -->
                        <div id="dropZone"
                            class="absolute inset-0 bg-federal-50/90 backdrop-blur z-20 hidden flex-col items-center justify-center border-2 border-dashed border-federal-300 m-2 rounded-xl text-federal-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mb-1">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span class="text-xs font-bold text-federal-700">Datei hier ablegen</span>
                        </div>

                        <form onsubmit="event.preventDefault(); sendMessage();" class="flex gap-2">
                            <label
                                class="cursor-pointer p-2.5 text-gray-400 hover:text-federal-600 hover:bg-federal-50 rounded-xl transition-colors"
                                title="Datei hochladen (PDF, DOCX, TXT)">
                                <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt,.md"
                                    onchange="handleFileUpload(this.files[0])">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                    </path>
                                </svg>
                            </label>

                            <input type="text" id="chatInput" placeholder="Frage stellen..."
                                class="flex-1 bg-gray-50 border-0 focus:ring-0 text-sm placeholder-gray-400 py-2.5 px-1 focus:outline-none"
                                autocomplete="off">

                            <button type="submit"
                                class="p-2.5 bg-federal-900 text-white rounded-xl hover:bg-federal-700 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                                id="sendBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Floating Toggle Button (Hidden by default) -->
            <button id="chatToggleBtn" onclick="toggleChat()"
                class="absolute bottom-8 right-8 z-20 w-14 h-14 bg-federal-900 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-federal-800 transition-all transform hover:scale-110 hidden pointer-events-auto"
                title="Chat öffnen">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>

            <!-- SVG Container -->
            <svg id="graph" class="w-full h-full graph-container"></svg>

            <!-- Discovery Log Overlay -->
            <div id="discoveryLog" class="absolute bottom-32 left-8 z-10 w-64 max-h-32 overflow-hidden pointer-events-none flex flex-col gap-1">
                <!-- Log entries will be prepended here -->
            </div>

            <!-- Tooltip -->
            <div id="tooltip"
                class="absolute hidden bg-federal-900 text-white px-3 py-2 rounded-lg text-xs shadow-xl max-w-xs transition-opacity duration-200">
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside id="sidebar" class="w-1/3 bg-white border-l border-gray-200 shadow-2xl flex flex-col z-20">
            <div class="p-8 border-b border-gray-100 bg-gray-50/50">
                <div class="flex justify-between items-start mb-4">
                    <span id="docCategory"
                        class="text-[10px] font-bold tracking-widest uppercase text-federal-500 px-2 py-1 bg-federal-50 rounded">Kategorie</span>
                    <button onclick="closeSidebar()" class="text-gray-400 hover:text-federal-900 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <h2 id="docTitle" class="text-2xl font-serif leading-tight mb-2">Wählen Sie ein Dokument aus</h2>
                <div id="docKuerzel" class="text-xs text-federal-600 font-bold mb-4"></div>
                <div class="flex flex-wrap gap-2 mb-6">
                    <a id="docLink" href="#" target="_blank"
                        class="text-xs flex items-center gap-1.5 text-federal-600 hover:text-federal-800 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        PDF Dokument öffnen
                    </a>
                </div>
                <div id="docStats" class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Regeln</div>
                        <div id="ruleCount" class="text-xl font-serif">0</div>
                    </div>
                    <div id="docIdContainer" class="bg-white p-3 rounded-lg border border-gray-100">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">ID</div>
                        <div id="docId" class="text-xl font-serif">--</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto sidebar-scroll p-8">
                <h3 class="text-sm font-bold uppercase tracking-widest text-federal-800 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Extrahierte Regeln
                </h3>

                <div class="mb-6">
                    <input type="text" id="ruleSearch" oninput="filterRules()" 
                        placeholder="Regeln durchsuchen..." 
                        class="w-full text-xs p-2.5 rounded-lg border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-federal-200 outline-none transition-all shadow-inner">
                </div>

                <div id="rulesList" class="space-y-6">
                    <!-- Rules will be injected here -->
                    <div class="text-center py-12 text-gray-400 italic font-serif">
                        Keine Regeln ausgewählt
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Data management
        let graphData = null;
        let knowledgeData = null;
        let documentRules = {}; // docId -> list of rules
        let currentRules = []; // rules of currently selected node
        let uploadedFile = null;
        let uploadedDocId = null;
        let chatHistory = [];

        const svg = d3.select("#graph");
        const width = window.innerWidth * 0.66;
        const height = window.innerHeight;

        const g = svg.append("g");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => g.attr("transform", event.transform));

        svg.call(zoom);

        function zoomIn() { svg.transition().call(zoom.scaleBy, 1.3); }
        function zoomOut() { svg.transition().call(zoom.scaleBy, 0.7); }
        function resetZoom() { svg.transition().call(zoom.transform, d3.zoomIdentity); }

        function autoZoom() {
            // Get bounding box of all nodes
            const nodes = d3.selectAll(".node");
            if (nodes.empty()) return;

            // Calculate bounds
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            graphData.nodes.forEach(d => {
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });

            const dx = maxX - minX,
                dy = maxY - minY,
                x = (minX + maxX) / 2,
                y = (minY + maxY) / 2,
                scale = Math.max(0.1, Math.min(4, 0.9 / Math.max(dx / width, dy / height)));

            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(scale)
                .translate(-x, -y);

            svg.transition().duration(750).call(zoom.transform, transform);
        }

        // Exposed helper to zoom to a node by ID (for Markdown links)
        window.zoomToNode = function(nodeId) {
            if (!graphData) return;
            const node = graphData.nodes.find(n => n.id === nodeId);
            if (node) {
                // Trigger selection and zoom
                selectNode(node);
                
                // Zoom logic
                const scale = 2;
                const transform = d3.zoomIdentity
                    .translate(width / 2, height / 2)
                    .scale(scale)
                    .translate(-node.x, -node.y);
                
                d3.select("#graph").transition().duration(1000).call(zoom.transform, transform);
                
                // Highlight temporarily
                d3.selectAll(".node").filter(d => d.id === nodeId)
                    .attr("stroke", "#D4AF37")
                    .attr("stroke-width", 6)
                    .transition().duration(2000)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2);
            } else {
                console.warn("Node not found:", nodeId);
            }
        };

        function zoomToVisible() {
            // Get bounding box of visible (non-dimmed) nodes
            const visibleNodes = d3.selectAll(".node:not(.dimmed)");
            if (visibleNodes.empty()) return; // Keep current view if nothing visible

            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            let count = 0;

            visibleNodes.each(d => {
                count++;
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });

            if (count === 0) return;

            const dx = maxX - minX || 100, // Fallback width if single point
            dy = maxY - minY || 100,
            x = (minX + maxX) / 2,
            y = (minY + maxY) / 2,
            scale = Math.max(0.1, Math.min(4, 0.9 / Math.max(dx / width, dy / height)));

            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(scale)
                .translate(-x, -y);

            svg.transition().duration(750).call(zoom.transform, transform);
        }

        // Simulation
        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(60));

        // Load Data
        async function loadData() {
            try {
                // Robust Fetching: Try absolute first, then relative
                let docsResponse = await fetch('/data/d3_graph_documents.json');
                if (!docsResponse.ok) docsResponse = await fetch('data/d3_graph_documents.json');

                let knowledgeResponse = await fetch('/data/knowledge_graph.json');
                if (!knowledgeResponse.ok) knowledgeResponse = await fetch('data/knowledge_graph.json');

                if (!docsResponse.ok || !knowledgeResponse.ok) throw new Error("Graph Data unavailable");

                graphData = await docsResponse.json();
                knowledgeData = await knowledgeResponse.json();

                populateFilters();
                processRules();
                renderGraph();

                // Initial auto-zoom
                setTimeout(autoZoom, 1000);
            } catch (error) {
                console.error("Error loading data:", error);

                // Friendly Error UI
                const container = document.getElementById('graph-container'); 
                const msg = `
                    <div class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 backdrop-blur-sm">
                        <div class="text-center p-8 bg-white rounded-xl shadow-2xl border border-red-100 max-w-md">
                            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Verbindungsproblem</h3>
                            <p class="text-gray-600 mb-4">Die Graph-Daten konnten nicht geladen werden.</p>
                            <p class="text-xs text-gray-400 mb-6 font-mono">${error.message}</p>
                            <button onclick="location.reload()" class="px-5 py-2.5 bg-federal-900 text-white rounded-lg hover:bg-federal-700 transition-colors shadow-lg">Neu laden</button>
                        </div>
                    </div>
                `;
                // Append to body or graph container
                if (document.getElementById('graph')) {
                    document.getElementById('graph').insertAdjacentHTML('beforebegin', msg);
                } else {
                    document.body.insertAdjacentHTML('afterbegin', msg);
                }
            }
        }

        function toggleChat() {
            const wrapper = document.getElementById('chatWrapper');
            const btn = document.getElementById('chatToggleBtn');
            const isHidden = wrapper.dataset.state === 'hidden';

            if (isHidden) {
                // Open
                wrapper.classList.remove('translate-x-[150%]', 'opacity-0', 'pointer-events-none');
                btn.classList.add('hidden');
                wrapper.dataset.state = 'visible';
            } else {
                // Close
                wrapper.classList.add('translate-x-[150%]', 'opacity-0', 'pointer-events-none');
                btn.classList.remove('hidden');
                wrapper.dataset.state = 'hidden';
            }
        }

        function populateFilters() {
            const ministries = new Set();
            const types = new Set();

            graphData.nodes.forEach(n => {
                if (n.ministerium) {
                    const min = n.ministerium.trim();
                    if (min && min !== "unbekannt") ministries.add(min);
                }
                if (n.herausgeber) {
                    const iss = n.herausgeber.trim();
                    if (iss && iss !== "unbekannt") ministries.add(iss);
                }
                if (n.kuerzel) {
                    const type = n.kuerzel.trim();
                    if (type) types.add(type);
                }
            });

            const minSelect = document.getElementById('filterMinistry');
            minSelect.innerHTML = '<option value="">Alle Ressorts</option>';
            Array.from(ministries).sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                minSelect.appendChild(opt);
            });

            const typeSelect = document.getElementById('filterType');
            typeSelect.innerHTML = '<option value="">Alle Typen</option>';
            Array.from(types).sort().forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.innerText = t;
                typeSelect.appendChild(opt);
            });
        }

        function processRules() {
            knowledgeData.nodes.forEach(node => {
                // Check if it's a chunk/paragraph
                if ((node.type === 'chunk' || node.node_type === 'chunk') && node.id) {
                    let docId = null;
                    const parts = node.id.split('_');
                    
                    // Smart ID Parsing
                    if (node.id.startsWith('law_')) {
                        // e.g. law_BHO_§_1 -> docId = law_BHO
                        if (parts.length >= 2) docId = parts[0] + '_' + parts[1];
                    } else {
                        // e.g. 0347_chunk_1 -> docId = 0347
                        docId = parts[0];
                    }

                    if (!docId) return;
                    if (!documentRules[docId]) documentRules[docId] = [];

                    // 1. Explicit Rules
                    if (node.rules && node.rules.length > 0) {
                        node.rules.forEach(rule => {
                            documentRules[docId].push({
                                ...rule,
                                context: node.context,
                                headings: node.headings,
                                isFallback: false
                            });
                        });
                    } 
                    // 2. Fallback: Use Text as Rule (for Laws/Paragraphs without explicit extraction)
                    else if (node.text && node.text.length > 10) {
                        // Only if it looks like a rule (heuristic)
                        // Or just take it all for laws
                        const isLaw = node.id.includes('law_') || node.id.includes('§');
                        if (isLaw || node.text.length < 500) {
                             documentRules[docId].push({
                                category: isLaw ? "Gesetzestext" : "Inhalt",
                                rule: node.text.substring(0, 300) + (node.text.length > 300 ? "..." : ""),
                                value: null,
                                isFallback: true
                            });
                        }
                    }
                }
            });
        }

        function renderGraph() {
            const nodes = graphData.nodes;
            const links = graphData.links;

            // Define arrowheads
            svg.append("defs").selectAll("marker")
                .data(["SUPERSEDES", "REFERENCES", "default"])
                .enter().append("marker")
                .attr("id", d => `arrow-${d}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("fill", d => {
                    if (d === "SUPERSEDES") return "#ef4444";
                    if (d === "REFERENCES") return "#D4AF37";
                    return "#cbd5e1";
                })
                .attr("d", "M0,-5L10,0L0,5");

            const linkElements = g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(links)
                .enter().append("path")
                .attr("class", d => `link ${d.relation?.toLowerCase() || ''}`)
                .attr("stroke", d => d.relation === "REFERENCES" ? "#D4AF37" : null)
                .attr("marker-end", d => {
                    if (d.relation === "SUPERSEDES") return "url(#arrow-SUPERSEDES)";
                    if (d.relation === "REFERENCES") return "url(#arrow-REFERENCES)";
                    return "url(#arrow-default)";
                });

            const nodeElements = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => (d.node_type === "law" || d.type === "law") ? 16 : 12)
                .attr("fill", d => (d.node_type === "law" || d.type === "law") ? "#f97316" : "#003366")
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", (e, d) => selectNode(d))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            const labels = g.append("g")
                .attr("class", "labels")
                .selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "text-[8px] font-sans fill-federal-500 pointer-events-none")
                .attr("dy", 24)
                .attr("text-anchor", "middle")
                .text(d => d.title.length > 25 ? d.title.substring(0, 22) + "..." : d.title);

            simulation.nodes(nodes).on("tick", () => {
                linkElements.attr("d", d => {
                    const dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        dr = Math.sqrt(dx * dx + dy * dy);
                    // Use arcs for superseded links to distinguish
                    if (d.relation === "SUPERSEDES") {
                        return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                    }
                    return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
                });

                nodeElements
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            simulation.force("link").links(links);
        }

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tooltip
        const tooltip = d3.select("#tooltip");
        function showTooltip(event, d) {
            tooltip.style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px")
                .html(`
                    <div class="font-bold mb-1">${d.title}</div>
                    <div class="opacity-70">${d.category}</div>
                `);

            // Highlight neighbors
            const neighbors = new Set();
            graphData.links.forEach(l => {
                if (l.source.id === d.id) neighbors.add(l.target.id);
                if (l.target.id === d.id) neighbors.add(l.source.id);
            });

            d3.selectAll(".node").classed("dimmed", n => n.id !== d.id && !neighbors.has(n.id));
            d3.selectAll(".link").classed("dimmed", l => l.source.id !== d.id && l.target.id !== d.id);
        }

        function hideTooltip() {
            tooltip.style("display", "none");
            // Restore filter state (don't clear dimmed blindly)
            applyFilters(false); // false = don't zoom
        }

        // Sidebar & Interaction
        function selectNode(d) {
            document.getElementById('docTitle').innerText = d.title;
            document.getElementById('docKuerzel').innerText = d.kuerzel ? `[${d.kuerzel}]` : '';
            const categoryText = d.ministerium ? `${d.ministerium.toUpperCase()} | ${d.category}` : d.category;
            document.getElementById('docCategory').innerText = categoryText;
            document.getElementById('docId').innerText = d.id;
            document.getElementById('docLink').href = d.url;

            const rules = documentRules[d.id] || [];
            currentRules = rules;
            document.getElementById('ruleCount').innerText = rules.length;
            
            // Reset search field
            document.getElementById('ruleSearch').value = '';

            // Add Stand info if available
            const statsGrid = document.getElementById('docStats');
            const standDivId = 'docStandContainer';
            let standDiv = document.getElementById(standDivId);
            if (!standDiv) {
                standDiv = document.createElement('div');
                standDiv.id = standDivId;
                standDiv.className = 'bg-white p-3 rounded-lg border border-gray-100';
                statsGrid.appendChild(standDiv);
            }
            standDiv.innerHTML = `
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Stand / Herausgeber</div>
                <div class="text-sm font-serif truncate">${d.stand || '--'}</div>
                <div class="text-[10px] text-gray-500 truncate">${d.herausgeber || ''}</div>
            `;

            renderRules(rules);
            document.getElementById('sidebar').classList.remove('translate-x-full');
        }

        function renderRules(rules) {
            const rulesContainer = document.getElementById('rulesList');
            rulesContainer.innerHTML = '';

            if (rules.length === 0) {
                rulesContainer.innerHTML = '<div class="text-center py-12 text-gray-400 italic font-serif">Keine Regeln gefunden</div>';
            } else {
                rules.forEach(rule => {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.className = 'rule-card bg-gray-50 p-4 rounded-r-lg hover:bg-white hover:shadow-md transition-all';
                    ruleDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold uppercase tracking-widest text-federal-500 bg-white border border-gray-200 px-2 py-0.5 rounded-full shadow-sm">${rule.category}</span>
                            ${rule.value ? `<span class="text-xs font-mono font-bold text-federal-900 bg-yellow-100 px-2 py-0.5 rounded">${rule.value}</span>` : ''}
                        </div>
                        <p class="text-sm text-federal-900 leading-relaxed font-medium">${rule.rule}</p>
                        ${rule.headings && rule.headings.length > 0 ? `<div class="mt-2 text-[10px] text-gray-400 uppercase tracking-tighter flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg> ${rule.headings[rule.headings.length-1]}</div>` : ''}
                    `;
                    rulesContainer.appendChild(ruleDiv);
                });
            }
        }

        function filterRules() {
            const query = document.getElementById('ruleSearch').value.toLowerCase();
            const filtered = currentRules.filter(r => 
                r.rule.toLowerCase().includes(query) || 
                r.category.toLowerCase().includes(query) ||
                (r.value && String(r.value).toLowerCase().includes(query))
            );
            renderRules(filtered);
        }

        function closeSidebar() {
            // document.getElementById('sidebar').classList.add('translate-x-full'); 
            // We actually don't hide it in this layout, maybe just clear selection?
            // For now, do nothing or reset selection visuals
            d3.selectAll(".node").classed("dimmed", false);
            d3.selectAll(".link").classed("dimmed", false);
        }

        function addLogEntry(message, type = 'info') {
            const log = document.getElementById('discoveryLog');
            const entry = document.createElement('div');
            entry.className = `p-2 rounded text-[9px] font-bold uppercase tracking-tight shadow-sm backdrop-blur-md border animate-slide-in pointer-events-auto transition-all hover:scale-105 cursor-default`;
            
            if (type === 'discovery') {
                entry.className += ' bg-federal-900/90 text-white border-federal-700';
                entry.innerHTML = `⚡ discovery: ${message}`;
            } else if (type === 'warning') {
                entry.className += ' bg-red-500/90 text-white border-red-400';
                entry.innerHTML = `⚠️ alert: ${message}`;
            } else {
                entry.className += ' bg-white/80 text-federal-600 border-gray-100';
                entry.innerHTML = `ℹ️ system: ${message}`;
            }

            log.prepend(entry);
            
            // Auto-remove after 10s
            setTimeout(() => {
                entry.classList.add('opacity-0', '-translate-x-full');
                setTimeout(() => entry.remove(), 500);
            }, 10000);
        }

        // --- Chat Logic ---

        // Custom Renderer for Marked to handle Graph Links
        const renderer = new marked.Renderer();
        const originalLink = renderer.link;
        renderer.link = function(href, title, text) {
            // Check if it's an internal graph link (e.g. #graph:nodeId)
            if (href && href.startsWith('#graph:')) {
                const nodeId = href.split(':')[1];
                return `<a href="#" onclick="event.preventDefault(); zoomToNode('${nodeId}');" class="font-bold text-federal-700 hover:text-accent-gold transition-colors border-b border-federal-200 hover:border-accent-gold" title="Im Graphen anzeigen">${text}</a>`;
            }
            return originalLink.call(this, href, title, text);
        };
        marked.use({ renderer });

        function handleFileUpload(file) {
            if (!file) return;
            uploadedFile = file;

            // Show preview
            document.getElementById('uploadPreview').classList.remove('hidden');
            document.getElementById('uploadFilename').innerText = file.name;
            
            // Focus chat input so user can type their question
            document.getElementById('chatInput').focus();
        }

        function clearUpload() {
            uploadedFile = null;
            uploadedDocId = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadPreview').classList.add('hidden');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const hasFile = !!uploadedFile;

            if (!message && !hasFile) return;

            // Clear input
            input.value = '';
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;

            // Optimistic UI Update
            let userMsg = message;
            if (hasFile && !message) userMsg = `Analysiere Dokument: ${uploadedFile.name}`;
            addMessage('user', userMsg);

            // Handle Upload first if needed
            if (hasFile && !uploadedDocId) {
                addMessage('ai', `<span class="animate-pulse">🔄 Lade Dokument hoch und analysiere...</span>`);
                const loadingMsg = document.getElementById('chatMessages').lastElementChild;
                
                try {
                    const formData = new FormData();
                    formData.append('file', uploadedFile);
                    
                    const uploadRes = await fetch('/chat/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadRes.ok) throw new Error("Upload fehlgeschlagen");
                    
                    const uploadData = await uploadRes.json();
                    uploadedDocId = uploadData.uploaded_doc_id;
                    
                    // If message was empty, trigger analysis automatically
                    if (!message) {
                        const analysisRes = await fetch('/chat/analyze-document', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ uploaded_doc_id: uploadedDocId })
                        });
                        
                        const analysisData = await analysisRes.json();
                        loadingMsg.remove(); // Remove loading
                        
                        // Format Analysis Result (HTML Version for robustness)
                        // Using HTML directly to ensure links work and formatting is clean
                        let responseText = `<h3 class="font-bold text-lg mb-4">Analyseergebnis für "${uploadedFile.name}"</h3>`;
                        
                         if (analysisData.mapped_regulations && analysisData.mapped_regulations.length > 0) {
                             responseText += '<p class="mb-4 text-sm text-gray-600">Basierend auf dem Knowledge Graph wurden folgende Regelwerke als relevant identifiziert:</p><div class="space-y-4">';
                             analysisData.mapped_regulations.forEach(reg => {
                                 if (reg.is_newly_crawled) {
                                     addLogEntry(`Gesetz '${reg.source_doc}' automatisch entdeckt!`, 'discovery');
                                 }
                                 
                                 let nodeId = reg.doc_id;

                                if(!nodeId && graphData && graphData.nodes) {
                                    const match = graphData.nodes.find(n => n.title === reg.source_doc || n.id === reg.source_doc);
                                    if(match) nodeId = match.id;
                                }
                                
                                 const ruleCount = reg.rules.length;
                                 const categoryColor = reg.category.includes('Explizit') ? 'bg-federal-100 text-federal-700' : 'bg-amber-50 text-amber-700';
                                 const isNew = reg.is_newly_crawled;
                                 
                                 responseText += `
                                     <div class="p-3 rounded-xl border border-gray-100 bg-white shadow-sm relative overflow-hidden">
                                         ${isNew ? `<div class="absolute top-0 right-0 bg-federal-900 text-white text-[8px] font-bold px-2 py-0.5 rounded-bl-lg uppercase tracking-tighter animate-pulse">⚡ Neu entdeckt</div>` : ''}
                                         <div class="flex justify-between items-start mb-1">
                                             <span class="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full ${categoryColor}">${reg.category}</span>
                                             <span class="text-[10px] text-gray-400 font-medium">${ruleCount} Regeln</span>
                                         </div>

                                        <div class="flex items-center gap-2">
                                            ${nodeId ? 
                                                `<a href="#" onclick="event.preventDefault(); zoomToNode('${nodeId}');" class="font-bold text-federal-800 hover:text-accent-gold transition-colors decoration-dotted underline underline-offset-4" title="Im Graphen anzeigen">${reg.source_doc}</a>` : 
                                                `<span class="font-bold text-federal-800">${reg.source_doc}</span>`
                                            }
                                        </div>
                                    </div>`;
                            });
                            responseText += '</div><p class="mt-6 text-[10px] italic text-gray-400 border-t pt-2">Die "Implizite Erweiterung" basiert auf Expertenwissen und verknüpft Begriffe wie "Reisekosten" automatisch mit dem BRKG, auch wenn dieses nicht explizit im Text genannt wird.</p>';
                        } else {
                            responseText += "<p>Keine spezifischen Referenzen im Knowledge Graph gefunden.</p>";
                        }
                        
                        // Pass directly as 'ai' message. Marked.js will render the HTML inside.
                        addMessage('ai', responseText);
                        btn.disabled = false;
                        return; 
                    }
                    
                    loadingMsg.remove(); // Remove loading spinner before chat query
                    
                } catch (e) {
                    loadingMsg.remove();
                    addMessage('ai', `❌ Fehler beim Upload: ${e.message}`);
                    btn.disabled = false;
                    return;
                }
            }

            // Normal Chat Query (with optional doc_id)
            try {
                // Show typing indicator
                addMessage('ai', '<span class="animate-pulse">Thinking...</span>');
                const loadingMsg = document.getElementById('chatMessages').lastElementChild;

                const res = await fetch('/chat/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory,
                        uploaded_doc_id: uploadedDocId
                    })
                });

                const data = await res.json();
                loadingMsg.remove();

                addMessage('ai', data.answer, data.results, data.suggested_questions);
                
                // Update History
                chatHistory.push({role: "user", content: message});
                chatHistory.push({role: "assistant", content: data.answer});
                
                // If the user uploaded a file and we processed it, maybe we can clear it now?
                // Or keep it for context? Let's keep it until manually cleared.

            } catch (error) {
                document.getElementById('chatMessages').lastElementChild.remove(); // Remove loading
                addMessage('ai', `⚠️ Fehler: ${error.message}`);
            }

            btn.disabled = false;
            // Focus input again
            setTimeout(() => document.getElementById('chatInput').focus(), 100);
        }

        function addMessage(role, content, sources = [], suggestions = []) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;

            const avatar = role === 'user' ?
                `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>` :
                `<div class="w-8 h-8 rounded-full bg-federal-100 flex items-center justify-center flex-shrink-0 text-federal-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                </div>`;

            // Parse Markdown for AI responses
            let htmlContent = content;
            if (role === 'ai') {
                try {
                    htmlContent = marked.parse(content);
                } catch(e) {
                    console.error("Markdown parse error", e);
                    htmlContent = content; // Fallback
                }
            } else {
                // Escape HTML for user input to prevent XSS
                htmlContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            msgDiv.innerHTML = `
                ${avatar}
                <div class="space-y-1 max-w-[85%]">
                    <div class="p-3 rounded-2xl shadow-sm text-sm ${role === 'user' ? 'bg-federal-900 text-white rounded-tr-none' : 'bg-gray-100 text-gray-800 rounded-tl-none border border-gray-200/50 prose prose-sm prose-a:text-federal-600 prose-a:font-bold prose-a:no-underline hover:prose-a:underline prose-p:mb-1 prose-ul:mb-1'}">
                        ${htmlContent}
                    </div>
                    ${sources.length > 0 ? renderSources(sources) : ''}
                    ${suggestions && suggestions.length > 0 ? renderSuggestions(suggestions) : ''}
                </div>
            `;

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function renderSources(sources) {
            return `
                <div class="flex gap-2 flex-wrap">
                    ${sources.map(s => `
                        <div class="text-[10px] bg-white border border-gray-200 px-2 py-1 rounded-md text-gray-500 flex items-center gap-1 cursor-pointer hover:border-federal-300 hover:text-federal-700 transition-colors" onclick="zoomToNode('${s.id}')">
                            <span class="w-1.5 h-1.5 rounded-full bg-accent-gold"></span>
                            <span class="truncate max-w-[150px]">${s.doc_title || 'Quelle'}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderSuggestions(suggestions) {
            return `
                <div class="flex gap-2 flex-wrap mt-2">
                    ${suggestions.map(q => `
                        <button onclick="useSuggestion('${q.replace(/'/g, "\\'")}')" 
                            class="text-xs px-3 py-1.5 bg-white border border-federal-200 rounded-full text-federal-600 hover:bg-federal-50 hover:border-federal-300 transition-colors shadow-sm text-left animate-fade-in">
                            ${q}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        function useSuggestion(text) {
            const input = document.getElementById('chatInput');
            input.value = text;
            input.focus();
            sendMessage();
        }

        // Initialize drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.remove('hidden');
            dropZone.classList.add('flex');
        }

        function unhighlight(e) {
            dropZone.classList.add('hidden');
            dropZone.classList.remove('flex');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFileUpload(files[0]);
        }

        // Toggle filters on filter header click
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const arrow = document.getElementById('filterArrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        // Handle Filter Changes
        function handleCategoryChange() {
            // ...
            applyFilters();
        }

        function applyFilters(zoom = true) {
            // ... (Filter Logic here - kept simple for brevity as logic was mostly complete)
            const cat = document.getElementById('filterCategory').value;
            const min = document.getElementById('filterMinistry').value;
            const type = document.getElementById('filterType').value;
            const date = document.getElementById('filterDateStart').value;

            d3.selectAll(".node").classed("dimmed", d => {
                let hide = false;
                if (cat && d.category !== cat && d.node_type !== cat && d.type !== cat) hide = true;
                // Basic filtering logic
                if (min && d.ministerium !== min && d.herausgeber !== min) hide = true;
                if (type && d.kuerzel !== type) hide = true;
                return hide;
            });
            
            if(zoom) zoomToVisible();
        }

        function clearFilters() {
            document.getElementById('filterCategory').value = "";
            document.getElementById('filterMinistry').value = "";
            document.getElementById('filterType').value = "";
            document.getElementById('filterDateStart').value = "";
            applyFilters();
        }

        // Start
        loadData();
    </script>
</body>

</html>